---
title: "Example_workflow"
author: "Jacob Strunk"
date: "5/7/2020"
output: html_document
---

load packages - requires devtools package
```{r , eval = FALSE}
devtools::install_github("Jean-Romain/lidR")
devtools::install_github("Jean-Romain/rlas")
devtools::install_github("jacobstrunk001/RSForInvt")

```

#convert dtm raster to fusion .dtm rasters
```{r}
#library(RSForInvt)
RSForInvt::raster2FUSION("D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM\\","D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM_fusion\\")


```


#scan a lidar project
```{r}
library(lidR)
library(RSForInvt)

 las_info = scan_las(
    project="TN_lidar"
    ,project_year="2018"
    ,proj4_name=NA #"NAD_1983_HARN_StatePlane_Washington_South_FIPS_4601_Feet"
    ,proj4= NA 
    ,dir_las = "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\lidar_tiles\\"
    ,pattern="[.]la.$"
    ,notes=""
    ,create_polys=T
    ,recursive = T
    ,return=T
    )

#look at results that are returned directly 
las_info$project_id
View(las_info$las_ids) 
plot(las_info$plys) 

#grab the exact same data from geopackage
plys_las = rgdal::readOGR(dsn = "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\lidar_tiles\\manage_las\\manage_las.gpkg" , layer = "las_polys" )
con_gpkg = dbConnect(RSQLite::SQLite(), "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\lidar_tiles\\manage_las\\manage_las.gpkg")
las_ids = dbReadTable(con_gpkg,"las_id")
proj_id = dbReadTable(con_gpkg,"project_id")  

plot(plys_las)
proj_id
View(las_ids)

dbDisconnect(con_gpkg)

```


#scan dtms
```{r}
library(lidR)
library(RSForInvt)

 dtm_info = scan_dtm(
    project="TN_lidar"
    ,project_year="2018"
    ,proj4_name=NA #"NAD_1983_HARN_StatePlane_Washington_South_FIPS_4601_Feet"
    ,proj4= NA 
    ,dir_dtm = "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM_fusion"
    ,pattern="[.]dtm$"
    ,notes=""
    ,create_polys=T
    ,recursive = T
    ,return=T
    )

#look at results that are returned directly 
dtm_info$project_id
View(dtm_info$dtm_ids) 
plot(dtm_info$plys) 

#grab the exact same data from geopackage
plys_dtm = rgdal::readOGR(dsn = "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM_fusion\\manage_dtm\\manage_dtm.gpkg" , layer = "dtm_polys" )
con_gpkg_dtm = dbConnect(RSQLite::SQLite(), "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM_fusion\\manage_dtm\\manage_dtm.gpkg")
dtm_ids = dbReadTable(con_gpkg_dtm,"dtm_id")
proj_id_dtm = dbReadTable(con_gpkg_dtm,"project_id")  

proj_id_dtm
View(dtm_ids)
plot(plys_dtm)

dbDisconnect(con_gpkg)

if(F){
  
  plot(subset(plys_dtm,subset = 1:nrow(plys_dtm) ==1  ))
  plot( plys_las , add=T , border = "red")
    
}

```


#build project
```{r }

library(RSForInvt)

#proj_tn = RSForInvt::project_create(
proj_tn = project_create(
  dir_las="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\lidar_tiles\\"
  ,dir_dtm="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM_fusion\\"
  ,path_gpkg_out="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\R\\DAP_Lidar_analysis\\RSForInvt\\project\\TNLidar_RSForInvtProject.gpkg"
  ,layer_project = "RSForInvt_prj"
  ,layer_config = "RSForInvt_config"
  ,overwrite_project = T
  ,project_dtm="lidar_dtm"
  ,project_las="lidar_las"
  ,dtm_year="2018"
  ,las_year="2018"
  ,do_scan_dtms=F #we already scanned the dtm folder - ok, to rescan, but slower
  ,do_scan_las=F #we already scanned the las folder - ok, to rescan, but slower
  ,tile_size=6000
  ,pixel_size=66
  #,xmn=561066,xmx=2805066,ymn=33066,ymx=1551066
  ,proj4 = "+proj=lcc +lat_1=47.33333333333334 +lat_2=45.83333333333334 +lat_0=45.33333333333334 +lon_0=-120.5 +x_0=500000.0001016001 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs"
  ,mask=NA
  ,return=T
)

proj_tn$las_tiles_bfr
proj_tn$dtm_tiles_bfr
proj_tn$project_plys

```


#create gridmetrics output csvs
```{r }

  gmi=run_gridmetrics(
    proj_gpkg_path="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\R\\DAP_Lidar_analysis\\RSForInvt\\project\\TNLidar_RSForInvtProject.gpkg"
    ,dir_out="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\R\\DAP_Lidar_analysis\\RSForInvt\\"
    #,new_las_path=c(from="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\lidar_tiles\\",to = "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\lidar_tiles\\")
    #,new_dtm_path=c(from="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM_fusion\\",to = "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM_fusion\\")
    ,n_core=4
   )



```


#load csvs into sqlite database
```{r }


csv_to_sqlite(
      db="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\R\\DAP_Lidar_analysis\\RSForInvt\\gridmetrics_sqlite\\gridmetrics.sqlite"
       ,csv_folder = "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\R\\DAP_Lidar_analysis\\RSForInvt\\gridmetrics_csv"
       ,tb_summary="gm_summary"
       ,tb_csv="gm"
       ,project="TN_2018"
       ,resolution="66"
       ,units="feet"
       ,proj4="+proj=lcc +lat_1=47.33333333333334 +lat_2=45.83333333333334 +lat_0=45.33333333333334 +lon_0=-120.5 +x_0=500000.0001016001 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs"
       ,notes=""
       ,skip_loaded=T
       ,n_load=NA
       ,use_col_classes=T
       )



```


#create rasters from sqlite database
```{r }



```


#create .dtm canopy models
```{r }

  gmi=run_canopyModel(
    proj_gpkg_path="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\R\\DAP_Lidar_analysis\\RSForInvt\\project\\TNLidar_RSForInvtProject.gpkg"
    ,dir_out="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\R\\DAP_Lidar_analysis\\RSForInvt\\"
    #,new_las_path=c(from="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\lidar_tiles\\",to = "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\lidar_tiles\\")
    #,new_dtm_path=c(from="D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM_fusion\\",to = "D:\\Box\\VMARS\\Projects\\DAP_evaluation_Meston\\Data\\Tennessee\\DTM_fusion\\")
    ,n_core=4
   )



```


#merge .dtm canopy models
```{r }



```


#segment individual trees
```{r }



```


#clip plots from lidar
```{r }



```


#summarize plot clips
```{r }



```


#interpolate raster data to plot locations (alternative to plot clips)
```{r }



```

